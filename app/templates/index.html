<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理获取器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status { margin-top: 20px; font-weight: bold; }
        #proxyLists { margin-top: 20px; }
        .proxy-section { margin-bottom: 30px; }
        h2 { color: #555; }
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            padding: 10px;
            white-space: pre-wrap; /* 允许换行 */
            word-wrap: break-word; /* 长单词换行 */
            max-height: 300px;
            overflow-y: auto; /* 垂直滚动条 */
        }
        /* 日志区域样式 */
        #logArea {
            margin-top: 30px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #2c2c2c; /* 深色背景 */
            color: #f8f8f2; /* 浅色文字 */
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        #logHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #logHeader button {
            background-color: #555;
            font-size: 14px;
            padding: 5px 10px;
        }
        #logs {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

    <h1>代理获取器</h1>
    <button id="fetchButton">获取代理</button>
    <div id="status">状态: 等待操作</div>

    <div id="proxyLists">
        <div class="proxy-section">
            <h2>HTTP 代理</h2>
            <button onclick="loadProxies('http')">加载 HTTP 代理</button>
            <pre id="httpProxies">点击按钮加载代理列表</pre>
        </div>
        <div class="proxy-section">
            <h2>SOCKS5 代理</h2>
            <button onclick="loadProxies('socks5')">加载 SOCKS5 代理</button>
            <pre id="socks5Proxies">点击按钮加载代理列表</pre>
        </div>
    </div>

    <!-- 新增日志显示区域 -->
    <div id="logArea">
        <div id="logHeader">
            <h2>后端日志</h2>
            <button id="clearLogButton">清空日志</button>
        </div>
        <pre id="logs">正在加载日志...</pre>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const fetchButton = document.getElementById('fetchButton');
        const httpProxiesPre = document.getElementById('httpProxies');
        const socks5ProxiesPre = document.getElementById('socks5Proxies');
        // 日志相关元素
        const logsPre = document.getElementById('logs');
        const clearLogButton = document.getElementById('clearLogButton');

        let logFetchInterval; // 用于存储定时器ID

        // 获取并显示后端日志的函数
        async function fetchAndDisplayLogs() {
            try {
                const response = await fetch('/api/logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const logs = data.logs || [];
                logsPre.textContent = logs.join('\n'); // 将日志数组用换行符连接
                // 滚动到底部
                logsPre.scrollTop = logsPre.scrollHeight;
            } catch (error) {
                console.error('获取日志失败:', error);
                logsPre.textContent = `获取日志失败: ${error.message}\n请检查网络连接或后端服务。`;
            }
        }

        // 开始定时获取日志 (例如每2秒一次)
        function startLogFetching() {
            fetchAndDisplayLogs(); // 立即获取一次
            logFetchInterval = setInterval(fetchAndDisplayLogs, 2000);
        }

        // 停止定时获取日志
        function stopLogFetching() {
            if (logFetchInterval) {
                clearInterval(logFetchInterval);
                logFetchInterval = null;
            }
        }

        // 清空日志显示区域
        clearLogButton.addEventListener('click', () => {
            logsPre.textContent = '日志已清空。';
        });

        // 获取代理的函数
        async function fetchProxies() {
            fetchButton.disabled = true;
            statusDiv.textContent = '状态: 正在获取...';

            try {
                const response = await fetch('/api/fetch_proxies', { method: 'POST' });
                // 检查响应是否成功
                if (!response.ok) {
                   const errorText = await response.text(); // 尝试获取错误文本
                   console.error('服务器返回错误状态:', response.status, '响应体:', errorText);
                   throw new Error(`服务器错误 (${response.status}): ${errorText.substring(0, 200)}...`); // 截取前200字符
                }
                const data = await response.json();
                if (data.success) {
                    statusDiv.textContent = '状态: 获取成功';
                } else {
                    statusDiv.textContent = `状态: 获取失败 (${data.error || '未知错误'})`;
                }
            } catch (error) {
                console.error('获取代理时出错:', error);
                statusDiv.textContent = `状态: 获取失败 (${error.message})`;
            } finally {
                fetchButton.disabled = false;
            }
        }

        // 加载代理列表的函数
        async function loadProxies(protocol) {
            const preElement = protocol === 'http' ? httpProxiesPre : socks5ProxiesPre;
            preElement.textContent = '正在加载...';

            try {
                const response = await fetch(`/api/get_proxies/${protocol}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.proxies && data.proxies.length > 0) {
                    preElement.textContent = data.proxies.join('\n');
                } else {
                    preElement.textContent = '代理列表为空';
                }
            } catch (error) {
                console.error(`加载 ${protocol} 代理失败:`, error);
                preElement.textContent = `加载失败: ${error.message}`;
            }
        }

        // 为按钮添加事件监听器
        fetchButton.addEventListener('click', fetchProxies);

        // 页面加载完成后开始获取日志
        window.addEventListener('load', () => {
            startLogFetching();
        });

        // 页面关闭前停止获取日志 (可选，但推荐)
        window.addEventListener('beforeunload', () => {
            stopLogFetching();
        });

    </script>

</body>
</html>



