<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代理获取器</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; color: #333; }
        h1 { color: #2c3e50; }
        button {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
 font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        #status { margin-top: 20px; font-weight: bold; color: #2c3e50; }
        #proxyLists { margin-top: 20px; }
        .proxy-section { margin-bottom: 30px; background-color: #fff; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { color: #34495e; margin-top: 0; }
        pre {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            padding: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
        }

        #logArea {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #bdc3c7;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #logHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        #logHeader h2 {
            margin: 0;
            color: #34495e;
        }
        #logHeader button {
            background-color: #95a5a6;
            font-size: 14px;
            padding: 5px 10px;
        }
        #logHeader button:hover {
             background-color: #7f8c8d;
        }
        #logsContainer {
            background-color: #fdfdfd;
            border: 1px solid #ddd;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .log-entry {
            margin: 0 0 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #2c3e50; }
        .log-warning { color: #e67e22; }
        .log-error { color: #e74c3c; }
        .log-debug { color: #95a5a6; }

        /* --- 新增：进度条样式 --- */
        #progressContainer {
            width: 100%;
            background-color: #ecf0f1;
            border-radius: 5px;
            margin-top: 10px;
            display: none; /* 默认隐藏 */
        }
        #progressBar {
            width: 0%;
            height: 20px;
            background-color: #3498db;
            border-radius: 5px;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>

    <h1>代理获取器</h1>
    <button id="fetchButton">获取代理</button>
    <div id="status">状态: 等待操作</div>
    
    <!-- 新增：进度条 -->
    <div id="progressContainer">
        <div id="progressBar">0%</div>
    </div>

    <div id="proxyLists">
        <div class="proxy-section">
            <h2>HTTP 代理</h2>
            <button onclick="loadProxies('http')">加载 HTTP 代理</button>
            <pre id="httpProxies">点击按钮加载代理列表</pre>
        </div>
        <div class="proxy-section">
            <h2>SOCKS5 代理</h2>
            <button onclick="loadProxies('socks5')">加载 SOCKS5 代理</button>
            <pre id="socks5Proxies">点击按钮加载代理列表</pre>
        </div>
    </div>

    <div id="logArea">
        <div id="logHeader">
            <h2>后端日志</h2>
            <button id="clearLogButton">清空日志</button>
        </div>
        <div id="logsContainer">正在加载日志...</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const fetchButton = document.getElementById('fetchButton');
        const httpProxiesPre = document.getElementById('httpProxies');
        const socks5ProxiesPre = document.getElementById('socks5Proxies');
        const logsContainer = document.getElementById('logsContainer');
        const clearLogButton = document.getElementById('clearLogButton');
         // 新增：进度条元素
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        let logFetchInterval;
        let statusFetchInterval; // 用于轮询任务状态

        function getLogEntryClass(logLine) {
             const levelMatch = logLine.match(/\[.*?\]\s+(\w+)/);
             if (levelMatch && levelMatch[1]) {
                 const level = levelMatch[1].toUpperCase();
                 if (level === 'WARNING') {
                     return 'log-warning';
                 } else if (level === 'ERROR' || level === 'CRITICAL') {
                     return 'log-error';
                 } else if (level === 'DEBUG') {
                     return 'log-debug';
                 }
             }
             return 'log-info';
        }

        async function fetchAndDisplayLogs() {
            try {
                const response = await fetch('/api/logs');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const logs = data.logs || [];
                logsContainer.innerHTML = '';
                logs.forEach(logLine => {
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${getLogEntryClass(logLine)}`;
                    logEntry.textContent = logLine;
                    logsContainer.appendChild(logEntry);
                });
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } catch (error) {
                console.error('获取日志失败:', error);
                logsContainer.innerHTML = `<div class="log-entry log-error">获取日志失败: ${error.message}</div><div class="log-entry log-error">请检查网络连接或后端服务。</div>`;
            }
        }

        function startLogFetching() {
            fetchAndDisplayLogs();
            logFetchInterval = setInterval(fetchAndDisplayLogs, 2000);
        }

        function stopLogFetching() {
            if (logFetchInterval) {
                clearInterval(logFetchInterval);
                logFetchInterval = null;
            }
        }

        clearLogButton.addEventListener('click', () => {
            logsContainer.innerHTML = '<div class="log-entry log-info">日志已清空。</div>';
        });

        // --- 修改：获取代理 (启动任务) ---
        async function fetchProxies() {
            fetchButton.disabled = true;
            statusDiv.textContent = '状态: 正在请求启动任务...';
            statusDiv.style.color = '#2c3e50';
            progressContainer.style.display = 'block'; // 显示进度条
            updateProgressBar(10); // 初始进度

            try {
                const response = await fetch('/api/fetch_proxies', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'started') {
                    statusDiv.textContent = '状态: 任务已启动';
                    statusDiv.style.color = '#27ae60';
                    updateProgressBar(30); // 任务启动
                    startStatusPolling(); // 开始轮询状态
                } else if (data.status === 'already_running') {
                     statusDiv.textContent = '状态: 任务已在运行中，请稍后再试';
                     statusDiv.style.color = '#e67e22';
                     updateProgressBar(0);
                } else {
                     throw new Error(`意外的响应状态: ${JSON.stringify(data)}`);
                }
            } catch (error) {
                console.error('启动获取代理任务时出错:', error);
                statusDiv.textContent = `状态: 启动任务失败 (${error.message})`;
                statusDiv.style.color = '#e74c3c';
                updateProgressBar(0);
                fetchButton.disabled = false; // 重新启用按钮
                progressContainer.style.display = 'none'; // 隐藏进度条
            }
        }
        
        // --- 新增：更新进度条 ---
        function updateProgressBar(percent) {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }

        // --- 新增：轮询任务状态 ---
        function startStatusPolling() {
             // 立即查询一次
             checkFetchStatus();
             // 设置定时器，例如每3秒查询一次
             statusFetchInterval = setInterval(checkFetchStatus, 3000);
        }
        
        function stopStatusPolling() {
            if (statusFetchInterval) {
                clearInterval(statusFetchInterval);
                statusFetchInterval = null;
            }
        }
        
        async function checkFetchStatus() {
            try {
                const response = await fetch('/api/fetch_status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const statusData = await response.json();
                
                // 根据状态更新UI
                if (statusData.is_running) {
                    statusDiv.textContent = '状态: 任务正在运行中...';
                    statusDiv.style.color = '#3498db';
                    // 可以根据需要调整进度 (这里简化处理)
                    updateProgressBar(60); 
                } else {
                    // 任务已完成或未运行
                    stopStatusPolling(); // 停止轮询
                    fetchButton.disabled = false; // 重新启用按钮
                    progressContainer.style.display = 'none'; // 隐藏进度条
                    
                    if (statusData.last_result === true) {
                        statusDiv.textContent = '状态: 任务完成成功';
                        statusDiv.style.color = '#27ae60';
                        updateProgressBar(100);
                    } else if (statusData.last_result === false) {
                         statusDiv.textContent = '状态: 任务完成但失败';
                         statusDiv.style.color = '#e74c3c';
                         updateProgressBar(100);
                    } else {
                         // last_result 为 null，可能从未运行过或被中断
                         statusDiv.textContent = '状态: 任务未运行';
                         statusDiv.style.color = '#2c3e50';
                         updateProgressBar(0);
                    }
                }
            } catch (error) {
                console.error('查询任务状态时出错:', error);
                // 可以选择继续轮询或停止
                // 这里选择停止轮询并显示错误
                stopStatusPolling();
                statusDiv.textContent = `状态: 查询任务状态失败 (${error.message})`;
                statusDiv.style.color = '#e74c3c';
                fetchButton.disabled = false;
                progressContainer.style.display = 'none';
            }
        }


        async function loadProxies(protocol) {
            const preElement = protocol === 'http' ? httpProxiesPre : socks5ProxiesPre;
            preElement.textContent = '正在加载...';

            try {
                const response = await fetch(`/api/get_proxies/${protocol}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.proxies && data.proxies.length > 0) {
                    preElement.textContent = data.proxies.join('\n');
                } else {
                    preElement.textContent = '代理列表为空';
                }
            } catch (error) {
                console.error(`加载 ${protocol} 代理失败:`, error);
                preElement.textContent = `加载失败: ${error.message}`;
            }
        }

        fetchButton.addEventListener('click', fetchProxies);

        window.addEventListener('load', () => {
            startLogFetching();
            // 页面加载时也可以检查一次任务状态
            checkFetchStatus(); 
        });

        window.addEventListener('beforeunload', () => {
            stopLogFetching();
            stopStatusPolling(); // 页面关闭时停止轮询
        });

    </script>

</body>
</html>



